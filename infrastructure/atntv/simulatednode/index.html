<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulted Node Data</title>
</head>
<body>
    <h1>Simulted Node Data</h1>

    <div style="display: flex; flex-direction: row; margin-left: 5vw;">
        <label for="dayDropdown" style="margin-right: 1vw;">Day to simulate: </label>
        <select id="dayDropdown" onchange="onDaySelectChange(event)">
            <option value="" selected disabled>Select an option</option>
            <option value="22">22/01/24</option>
            <option value="23">23/01/24</option>
            <option value="24">24/01/24</option>
            <option value="25">25/01/24</option>
            <option value="26">26/01/24</option>
            <option value="27">27/01/24</option>
            <option value="28">28/01/24</option>
        </select>
    </div>
    
    <div style="display: flex; flex-direction: row;">
        <div id="datacontainer" style="height: 80vh; overflow-y: scroll; padding: 1vw; margin-left: 5vw; background-color: #CCE3ED; width: 25vw;">
            <h3>Node readings</h3>
            <div id="data"></div>
        </div>
        <div style="display: flex; flex-direction: column;">
            <div style="margin-left: 5vw; margin-top: 2vh;">
                <span>difference: </span>
                <span id="difference">0</span>
            </div>
            <div style="margin-left: 5vw; margin-top: 2vh;">
                <span>difference EMA: </span>
                <span id="diffEMA">0.00</span>
            </div>
        </div>
        <div id="lectureEventsContianer" style="height: 80vh; overflow-y: scroll; padding: 1vw; margin-left: 5vw; background-color: #EDCDCC; width: 25vw;">
            <h3>Lecture events</h3>
            <div id="lectureEvents"></div>
        </div>
        
    </div>

    <div id="chartContainer">
        <div id="chart"></div>
    </div>

    <script type="module">
        import handleDayDropdown from "/infrastructure/atntv/simulatednode/handleDayDropdown.js"
        import * as d3 from "https://d3js.org/d3.v7.min.js";
        import { createChart } from "/infrastructure/atntv/simulatednode/nodeScatter.js";

        const spansObj = {
            differenceSpan: document.getElementById("difference"),
            diffEMASpan: document.getElementById("diffEMA")
        }

        const configObj = {speed: 10, alpha: 1/3};

        const crowdCountObj = {EMA: 0};

        const timestampObj = {};

        const wsObj = {};

        const dataArrObj = {dataArr: []}

        const handler = {
            get(target, property) {
                if (property === 'push') {
                    return (...args) => {
                        Array.prototype.push.apply(target.dataArr, args);
                        console.log("pushed")
                        const oldChart = document.getElementById("chart")
                        oldChart.replaceWith(createChart([...target.dataArr]));
                    };
                }
                return Reflect.get(target, property);
            },
        };

        const proxiedDataArrObj = new Proxy(dataArrObj, handler);

        window.onDaySelectChange = (event) => handleDayDropdown(event, spansObj, configObj, timestampObj, crowdCountObj, wsObj, proxiedDataArrObj)
    </script>
</body>
</html>